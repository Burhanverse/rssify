#!/bin/bash

echo "ðŸš€ Starting RSS-ify Setup..."
echo "======================================"

# Update repository if -c flag is provided
update_repo() {
    echo "ðŸ“¦ Updating repository..."
    git stash
    git pull --force
    git submodule update --init --recursive
    echo "âœ… Repository updated"
    echo "======================================"
}

if [[ "$1" == "-c" ]]; then
    update_repo
fi

# Install Node.js dependencies
echo "ðŸ“¦ Installing Node.js dependencies..."
npm install || {
    echo "âŒ Failed to install Node.js dependencies."
    exit 1
}
echo "âœ… Node.js dependencies installed"
echo "======================================"

# Start Python API in background
echo "ðŸ Starting Python API..."
bash api.sh &
API_PID=$!

# Wait a moment for API to start
sleep 3

# Check if API is still running
if ! kill -0 $API_PID 2>/dev/null; then
    echo "âŒ API failed to start"
    exit 1
fi

echo "âœ… API started (PID: $API_PID)"
echo "======================================"

# Start the bot
echo "ðŸ¤– Starting Telegram Bot..."
node bot.mjs

# Cleanup: Kill API when bot stops
echo ""
echo "ðŸ›‘ Shutting down..."
kill $API_PID 2>/dev/null
echo "âœ… Cleanup complete"
