#!/bin/bash

echo "ðŸš€ Starting RSS-ify Setup..."
echo "======================================"

# Update repository if -c flag is provided
update_repo() {
    echo "ðŸ“¦ Updating repository..."
    git stash
    git pull --force
    git submodule update --init --recursive
    echo "âœ… Repository updated"
    echo "======================================"
}

if [[ "$1" == "-c" ]]; then
    update_repo
fi

# Install Node.js dependencies
echo "ðŸ“¦ Installing Node.js dependencies..."
npm install || {
    echo "âŒ Failed to install Node.js dependencies."
    exit 1
}
echo "âœ… Node.js dependencies installed"
echo "======================================"

# Start Python API in background
echo "ðŸ Starting Python API..."
bash api.sh > /tmp/api.log 2>&1 &
API_PID=$!

# Wait for API to be ready
echo "â³ Waiting for API to be ready..."
for i in {1..30}; do
    if curl -s http://localhost:5000 >/dev/null 2>&1; then
        echo "âœ… API is running and ready!"
        break
    fi
    sleep 1
    if [ $i -eq 30 ]; then
        echo "âŒ API failed to start within 30 seconds"
        echo "ðŸ“‹ Last 20 lines of API log:"
        tail -20 /tmp/api.log
        exit 1
    fi
done

echo "======================================"

# Activate venv if it exists
if [ -d "api/venv" ]; then
    echo "ðŸ”§ Activating virtual environment..."
    source api/venv/bin/activate
fi

# Start the bot
echo "ðŸ¤– Starting Telegram Bot..."
node bot.mjs

# Cleanup: Kill all background processes
echo ""
echo "ðŸ›‘ Shutting down..."
kill $API_PID 2>/dev/null
pkill -P $$ 2>/dev/null
echo "âœ… Cleanup complete"
