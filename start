#!/bin/bash

echo "ðŸš€ Starting RSS-ify..."
echo "======================================"

# Update repository if -c flag is provided
update_repo() {
    echo "ðŸ“¦ Updating repository..."
    git stash
    git pull --force
    git submodule update --init --recursive
    echo "âœ… Repository updated"
}

if [[ "$1" == "-c" ]]; then
    update_repo
fi

# Install Node.js dependencies
echo "ðŸ“¦ Installing Node.js dependencies..."
npm install || {
    echo "âŒ Failed to install Node.js dependencies."
    exit 1
}
echo "âœ… Node.js dependencies installed"

# Activate venv if it exists
if [ -d "api/venv" ]; then
    echo "ðŸ”§ Activating virtual environment..."
    source api/venv/bin/activate
fi

# Start the bot
echo "ðŸ¤– Starting Telegram Bot..."
node bot.mjs

# Cleanup: Kill all background processes
echo ""
echo "ðŸ›‘ Shutting down..."
kill $API_PID 2>/dev/null
pkill -P $$ 2>/dev/null
echo "âœ… Cleanup complete"
